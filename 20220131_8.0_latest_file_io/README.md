# I/O Monitoring(MySQL 8.0)

insert後にtest.ibdが更新されないけどなんでだろ.

## preparements

```sh
$ docker run -it --rm -w /app -v ${PWD}:/app --entrypoint "" --cap-add=ALL --security-opt="seccomp=unconfined" --name some-mysql -e MYSQL_ROOT_PASSWORD=my-secret-pw -e MYSQL_DATABASE=database -d mysql:8.0 bash
$ docker run --rm -w /app -v ${PWD}:/app --cap-add=ALL --security-opt="seccomp=unconfined" --name some-mysql -e MYSQL_ROOT_PASSWORD=my-secret-pw -e MYSQL_DATABASE=database -d mysql:8.0
```

```sh
$ docker exec -it some-mysql bash
# apt update -qq && apt install -y procps strace
# strace -y -t -f -o ./strace.out docker-entrypoint.sh mysqld
# strace -y -s5 -t -f -o ./strace.out -p 1
```

<!-- # strace -s2048 -f -o ./strace.out docker-entrypoint.sh mysqld -->
<!-- # strace -tt -f -e trace=file,open,close,write -p 1 -->
<!-- # strace -tt -p 1 -->
<!-- # strace -tt -p 1 -e trace=file,close,write -o /tmp/strace.log -->
<!-- # strace -f -p {{ pid }} -o /tmp/strace.log -->

```sql
$ docker exec -it some-mysql mysql -uroot -pmy-secret-pw -D database
mysql> CREATE TABLE test (
  id int(10) unsigned NOT NULL AUTO_INCREMENT,
  val1 int(11) NOT NULL,
  val2 int(11) NOT NULL,
  PRIMARY KEY (id),
  KEY idx_val1 (val1),
  KEY idx_val2 (val2)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

```

```sh
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\177\2\0\0003\0\0\0\7\t\0\1\200\10\200\6\200\7\200\0\200\1\200\1\377\377\200\4\177"..., 4608, 28632064 <unfinished ...>
603   23:32:24 <... pwrite64 resumed> ) = 4608
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\210\0\354\08\0\0\0\7\356\201\5\0\0\0\7\f\2\373\356\201\5\0(\201\20\2\373\356"..., 512, 28636672 <unfinished ...>
603   23:32:24 <... pwrite64 resumed> ) = 512
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\210\2\0\08\0\0\0\7\356\201\5\0\0\0\7\f\2\373\356\201\5\0(\201\20\2\373\356"..., 1024, 28636672 <unfinished ...>
603   23:32:24 <... pwrite64 resumed> ) = 1024
638   23:32:24 pwrite64(37</var/lib/mysql/database/test.ibd>, "\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"..., 114688, 0 <unfinished ...>
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\212\0D\0\16\0\0\0\7\0\10\247\373\376\10\0\v\0\1\200\10\200\6\200\7\200\10\200\4"..., 512, 28637696 <unfinished ...>
638   23:32:24 <... pwrite64 resumed> ) = 114688
603   23:32:24 <... pwrite64 resumed> ) = 512
638   23:32:24 pwrite64(37</var/lib/mysql/database/test.ibd>, "\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"..., 114688, 0 <unfinished ...>
638   23:32:24 <... pwrite64 resumed> ) = 114688
638   23:32:24 pwrite64(37</var/lib/mysql/database/test.ibd>, "x\274G\10\0\0\0\0\0\18\234\0\0\0\1\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"..., 16384, 0 <unfinished ...>
638   23:32:24 <... pwrite64 resumed> ) = 16384
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\212\2\0\0\16\0\0\0\7\0\10\247\373\376\10\0\v\0\1\200\10\200\6\200\7\200\10\200\4"..., 1536, 28637696 <unfinished ...>
603   23:32:24 <... pwrite64 resumed> ) = 1536
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\215\2\0\0\0\0\0\0\7R\373\377\2\2\2\0V\0\4\2\2\0X\373\377\2\2\2\0"..., 8192, 28639232 <unfinished ...>
603   23:32:24 <... pwrite64 resumed> ) = 8192
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\220\0\254\0\23\0\0\0\7\0\0\0\0\0\0\23>\5\0\2\23&\373\376\10\0\v\0\1"..., 512, 28640768 <unfinished ...>
603   23:32:24 <... pwrite64 resumed> ) = 512
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\220\2\0\0\23\0\0\0\7\0\0\0\0\0\0\23>\5\0\2\23&\373\376\10\0\v\0\1"..., 1024, 28640768 <unfinished ...>
603   23:32:24 <... pwrite64 resumed> ) = 1024
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\222\0017\0n\0\0\0\7\26\373\377\4\2\2\3\32\373\377\4\2\2\3\36\373\377\4\2\2"..., 512, 28641792 <unfinished ...>
603   23:32:24 <... pwrite64 resumed> ) = 512
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\222\1\257\0n\0\0\0\7\26\373\377\4\2\2\3\32\373\377\4\2\2\3\36\373\377\4\2\2"..., 512, 28641792 <unfinished ...>
603   23:32:24 <... pwrite64 resumed> ) = 512
638   23:32:24 pwrite64(37</var/lib/mysql/database/test.ibd>, "\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"..., 16384, 114688 <unfinished ...>
638   23:32:24 <... pwrite64 resumed> ) = 16384
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\222\1\302\0n\0\0\0\7\26\373\377\4\2\2\3\32\373\377\4\2\2\3\36\373\377\4\2\2"..., 512, 28641792 <unfinished ...>
603   23:32:24 <... pwrite64 resumed> ) = 512
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\222\2\0\0n\0\0\0\7\26\373\377\4\2\2\3\32\373\377\4\2\2\3\36\373\377\4\2\2"..., 1024, 28641792 <unfinished ...>
603   23:32:24 <... pwrite64 resumed> ) = 1024
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\224\1\324\1\30\0\0\0\7\2\0046\373\377\4\2\2\4:\373\377\4\2\2\4>\373\377\4"..., 512, 28642816 <unfinished ...>
603   23:32:24 <... pwrite64 resumed> ) = 512
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\224\2\0\1\30\0\0\0\7\2\0046\373\377\4\2\2\4:\373\377\4\2\2\4>\373\377\4"..., 512, 28642816 <unfinished ...>
603   23:32:24 <... pwrite64 resumed> ) = 512
638   23:32:24 pwrite64(37</var/lib/mysql/database/test.ibd>, "\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"..., 16384, 131072 <unfinished ...>
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\225\0o\0\34\0\0\0\7\0\0\0\0\0\25\3\10\0\0\0\0\0\0\0\10\247\373\376\10"..., 512, 28643328 <unfinished ...>
638   23:32:24 <... pwrite64 resumed> ) = 16384
603   23:32:24 <... pwrite64 resumed> ) = 512
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\225\2\0\0\34\0\0\0\7\0\0\0\0\0\25\3\10\0\0\0\0\0\0\0\10\247\373\376\10"..., 1024, 28643328 <unfinished ...>
603   23:32:24 <... pwrite64 resumed> ) = 1024
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\227\0\201\0Z\0\0\0\7\373\376\10\0\v\0\1\200\10\200\6\200\7\200\10\200\4\0\4\0"..., 512, 28644352 <unfinished ...>
603   23:32:24 <... pwrite64 resumed> ) = 512
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\227\0\357\0Z\0\0\0\7\373\376\10\0\v\0\1\200\10\200\6\200\7\200\10\200\4\0\4\0"..., 512, 28644352 <unfinished ...>
603   23:32:24 <... pwrite64 resumed> ) = 512
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\227\2\0\0Z\0\0\0\7\373\376\10\0\v\0\1\200\10\200\6\200\7\200\10\200\4\0\4\0"..., 1024, 28644352) = 1024
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\231\0\275\0\35\0\0\0\7\321kW\333\177\37133\214\357\343\370\rZz\214u\30\373\357"..., 512, 28645376 <unfinished ...>
603   23:32:24 <... pwrite64 resumed> ) = 512
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\231\2\0\0\35\0\0\0\7\321kW\333\177\37133\214\357\343\370\rZz\214u\30\373\357"..., 2048, 28645376 <unfinished ...>
603   23:32:24 <... pwrite64 resumed> ) = 2048
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\235\0S\0K\0\0\0\7x_val2size\0\0\0\0\7\22\202\0\0\1"..., 8192, 28647424 <unfinished ...>
603   23:32:24 <... pwrite64 resumed> ) = 8192
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\235\2\0\0K\0\0\0\7x_val2size\0\0\0\0\7\22\202\0\0\1"..., 512, 28647424 <unfinished ...>
603   23:32:24 <... pwrite64 resumed> ) = 512
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\236\2\0\0h\0\0\0\7_record=0;stats_auto"..., 1024, 28647936 <unfinished ...>
603   23:32:24 <... pwrite64 resumed> ) = 1024
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\240\2\0\0[\0\0\0\7\1jval2\0\0\0\3\4\200\200\200\0\0\0\v\0\0"..., 1536, 28648960 <unfinished ...>
603   23:32:24 <... pwrite64 resumed> ) = 1536
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\243\2\0\0\30\0\0\0\7\10idx_val1\17\373\377*\373\376\201\240\0\23\0"..., 512, 28650496 <unfinished ...>
603   23:32:24 <... pwrite64 resumed> ) = 512
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\244\1\253\0\30\0\0\0\7\10idx_val2\17\373\377*\373\376\201\240\0\23\0"..., 512, 28651008 <unfinished ...>
603   23:32:24 <... pwrite64 resumed> ) = 512
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\244\2\0\0\30\0\0\0\7\10idx_val2\17\373\377*\373\376\201\240\0\23\0"..., 1536, 28651008 <unfinished ...>
603   23:32:24 <... pwrite64 resumed> ) = 1536
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\247\1\257\0L\0\0\0\7\340\10\36\236\301\202\360$<D'\343!~\6\36f\16\17\223"..., 512, 28652544 <unfinished ...>
603   23:32:24 <... pwrite64 resumed> ) = 512
638   23:32:24 write(24</var/lib/mysql/binlog.000002>, "\10\303\371a\"\1\0\0\0O\0\0\0\354\0\0\0\0\0\1\0\0\0\0\0\0\0\0\0\0\0\0"..., 393) = 393
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\247\2\0\0L\0\0\0\7\340\10\36\236\301\202\360$<D'\343!~\6\36f\16\17\223"..., 512, 28652544 <unfinished ...>
603   23:32:24 <... pwrite64 resumed> ) = 512
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\250\0.\0.\0\0\0\7\0\202\0\4\373\357\7\0.\1\10\373\357\7\20H\0\0\0\7"..., 512, 28653056 <unfinished ...>
603   23:32:24 <... pwrite64 resumed> ) = 512
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\250\08\0.\0\0\0\7\0\202\0\4\373\357\7\0.\1\10\373\357\7\20H\0\0\0\7"..., 512, 28653056 <unfinished ...>
603   23:32:24 <... pwrite64 resumed> ) = 512
603   23:32:24 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\250\1>\0.\0\0\0\7\0\202\0\4\373\357\7\0.\1\10\373\357\7\20H\0\0\0\7"..., 512, 28653056 <unfinished ...>
603   23:32:24 <... pwrite64 resumed> ) = 512
598   23:32:25 pwrite64(10</var/lib/mysql/#ib_16384_0.dblwr>, "\322\246\323=\0\0\1\3\0\0\0\0\0\0\0\0\0\0\0\0\1\265N.\0\2\0\0\0\0\0\0"..., 65536, 131072) = 65536
598   23:32:25 pwrite64(10</var/lib/mysql/#ib_16384_0.dblwr>, "~j\204]\0\0\0U\377\377\377\377\377\377\377\377\0\0\0\0\1\264\376\311E\277\0\0\0\0\0\0"..., 65536, 0 <unfinished ...>
598   23:32:25 <... pwrite64 resumed> ) = 65536
598   23:32:25 pwrite64(10</var/lib/mysql/#ib_16384_0.dblwr>, "\374_\351\241\0\0\0Z\377\377\377\377\377\377\377\377\0\0\0\0\1\264\377<E\277\0\0\0\0\0\0"..., 65536, 65536) = 65536
598   23:32:25 pwrite64(10</var/lib/mysql/#ib_16384_0.dblwr>, "\27D`\227\0\0\0\233\0\0\3\372\377\377\377\377\0\0\0\0\1\265\5\257E\277\0\0\0\0\0\0"..., 65536, 131072 <unfinished ...>
598   23:32:25 <... pwrite64 resumed> ) = 65536
598   23:32:25 pwrite64(10</var/lib/mysql/#ib_16384_0.dblwr>, "\204x\267\220\0\0\0\272\0\0\0\231\0\0\1\242\0\0\0\0\1\265\5\333E\277\0\0\0\0\0\0"..., 65536, 0) = 65536
598   23:32:25 pwrite64(10</var/lib/mysql/#ib_16384_0.dblwr>, "r\35\226\327\0\0\1\251\0\0\0x\377\377\377\377\0\0\0\0\1\265G\253E\277\0\0\0\0\0\0"..., 65536, 65536) = 65536
598   23:32:25 pwrite64(10</var/lib/mysql/#ib_16384_0.dblwr>, "\355\5\266E\0\0\0\7\0\0\0\0\0\0\0\0\0\0\0\0\1\265(\\\0\6\0\0\0\0\0\0"..., 65536, 131072) = 65536
598   23:32:25 pwrite64(10</var/lib/mysql/#ib_16384_0.dblwr>, "m\4D5\0\0\1\25\0\0\0\0\0\0\0\0\0\0\0\0\1\265N.\0\2\0\0\0\0\0\0"..., 65536, 0) = 65536
598   23:32:25 pwrite64(10</var/lib/mysql/#ib_16384_0.dblwr>, "\22\6p\272\0\0\0\1\0\0\0\0\0\0\0\0\0\0\0\0\1\265(u\0\5\0\0\0\0\0\0"..., 65536, 65536 <unfinished ...>
598   23:32:25 <... pwrite64 resumed> ) = 65536
598   23:32:25 pwrite64(10</var/lib/mysql/#ib_16384_0.dblwr>, "Y\244\204\32\0\0\1\32\0\0\0\0\0\0\0\0\0\0\0\0\1\265\36\242\0\2\0\0\0\0\0\0"..., 65536, 131072) = 65536
598   23:32:25 pwrite64(10</var/lib/mysql/#ib_16384_0.dblwr>, "g\177\2620\0\0\1\6\0\0\0\0\0\0\0\0\0\0\0\0\1\265#7\0\2\0\0\0\0\0\0"..., 65536, 0) = 65536
598   23:32:25 pwrite64(10</var/lib/mysql/#ib_16384_0.dblwr>, "Q\275\240g\0\0\1\7\0\0\0\0\0\0\0\0\0\0\0\0\1\265,\201\0\2\0\0\0\0\0\0"..., 65536, 65536) = 65536
598   23:32:25 pwrite64(10</var/lib/mysql/#ib_16384_0.dblwr>, "a\312\4\23\0\0\0^\377\377\377\377\377\377\377\377\0\0\0\0\1\265.\262E\277\0\0\0\0\0\0"..., 65536, 131072) = 65536
598   23:32:25 pwrite64(10</var/lib/mysql/#ib_16384_0.dblwr>, "\225\2061D\0\0\0\7\377\377\377\377\377\377\377\377\0\0\0\0\1\2658KE\277\0\0\0\0\0\0"..., 16384, 0) = 16384
603   23:32:25 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\250\2\0\0.\0\0\0\7\0\202\0\4\373\357\7\0.\1\10\373\357\7\20H\0\0\0\7"..., 512, 28653056 <unfinished ...>
603   23:32:25 <... pwrite64 resumed> ) = 512
603   23:32:25 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\251\0K\0\30\0\0\0\7\0\0\0\0\0\0\0\4\3\2\201j\251\373\376\5\0\5\0\1"..., 512, 28653568 <unfinished ...>
603   23:32:25 <... pwrite64 resumed> ) = 512
599   23:32:25 pwrite64(4</var/lib/mysql/ib_logfile0>, "\0\0\0\0\0\0\0\7\0\0\0\0\1\265O>\0\0\0\0\1\2657>\0\0\0\0\1\0\0\0"..., 512, 1536 <unfinished ...>
599   23:32:25 <... pwrite64 resumed> ) = 512
598   23:32:27 pwrite64(10</var/lib/mysql/#ib_16384_0.dblwr>, "x\314\31\327\0\0\0\5\377\377\377\377\377\377\377\377\0\0\0\0\1\265PKE\277\0\0\0\0\0\0"..., 16384, 65536) = 16384
599   23:32:27 pwrite64(4</var/lib/mysql/ib_logfile0>, "\0\0\0\0\0\0\0\10\0\0\0\0\1\265PK\0\0\0\0\1\2658K\0\0\0\0\1\0\0\0"..., 512, 512) = 512
6
```


```sql
mysql> insert into test (val1, val2) values (1, 6);
```

```sh
> cat strace.out | grep write
603   23:33:10 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\251\1\262\0\30\0\0\0\t\0\0\0\0\0\0\0\4\3\2\201j\251\373\376\5\0\5\0\1"..., 512, 28653568 <unfinished ...>
603   23:33:10 <... pwrite64 resumed> ) = 512
638   23:33:10 write(24</var/lib/mysql/binlog.000002>, "6\303\371a\"\1\0\0\0O\0\0\0u\2\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"..., 293) = 293
603   23:33:10 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\251\1\272\0\30\0\0\0\t\0\0\0\0\0\0\0\4\3\2\201j\251\373\376\5\0\5\0\1"..., 512, 28653568) = 512
603   23:33:10 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\251\1\304\0\30\0\0\0\t\0\0\0\0\0\0\0\4\3\2\201j\251\373\376\5\0\5\0\1"..., 512, 28653568 <unfinished ...>
603   23:33:10 <... pwrite64 resumed> ) = 512
598   23:33:11 pwrite64(10</var/lib/mysql/#ib_16384_0.dblwr>, "\372\37Dd\0\0\1\10\0\0\0\0\0\0\0\0\0\0\0\0\1\265Q\272\0\2\0\0\0\0\0\0"..., 65536, 131072) = 65536
598   23:33:11 pwrite64(10</var/lib/mysql/#ib_16384_0.dblwr>, "qm+d\0\0\0\5\0\0\0\0\0\0\0\0\0\0\0\0\1\265Q\304\0\7\0\0\0\0\0\0"..., 16384, 0) = 16384
603   23:33:11 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\251\2\0\0\30\0\0\0\t\0\0\0\0\0\0\0\4\3\2\201j\251\373\376\5\0\5\0\1"..., 512, 28653568 <unfinished ...>
603   23:33:11 <... pwrite64 resumed> ) = 512
603   23:33:11 pwrite64(4</var/lib/mysql/ib_logfile0>, "\200\0\332\252\0\21\0\21\0\0\0\t\0\0\0\2\1\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"..., 512, 28654080 <unfinished ...>
603   23:33:11 <... pwrite64 resumed> ) = 512
599   23:33:11 pwrite64(4</var/lib/mysql/ib_logfile0>, "\0\0\0\0\0\0\0\t\0\0\0\0\1\265Q\304\0\0\0\0\1\2659\304\0\0\0\0\1\0\0\0"..., 512, 1536) = 512
598   23:33:13 pwrite64(10</var/lib/mysql/#ib_16384_0.dblwr>, "\252)\37\275\0\0\0\5\377\377\377\377\377\377\377\377\0\0\0\0\1\265R\21E\277\0\0\0\0\0\0"..., 16384, 65536) = 16384
599   23:33:13 pwrite64(4</var/lib/mysql/ib_logfile0>, "\0\0\0\0\0\0\0\n\0\0\0\0\1\265R\21\0\0\0\0\1\265:\21\0\0\0\0\1\0\0\0"..., 512, 512) = 512

```
